#!/usr/bin/python3

# This script reads the AndroidManifest.xml files in the malicous_apk
# and benign_apk folders and copies the requested permissions into a
# CSV for later analysis

import os
from defusedxml import ElementTree
import json

def main():
    for directory in ['benign_apk', 'malicious_apk']:
        os.chdir(directory)
        valid_apks = []
        if os.path.isfile('valid_apks.txt'):
            with open('valid_apks.txt') as f:
                valid_apks = [line.strip() for line in f.readlines()]
        malformed_xml = []
        if os.path.isfile('malformed_xml.txt'):
            with open('malformed_xml.txt') as f:
                malformed_xml = [line.strip() for line in f.readlines()]
        fname_permission_map = {}
        for filename in valid_apks:
            if filename not in malformed_xml:
                os.chdir(filename[:-4])
                with open('AndroidManifest.xml') as xml_file:
                    et = ElementTree.parse(xml_file)
                    permissions = et.getroot().findall('./uses-permission')
                    fname_permission_map[filename] = []
                    for permission in permissions:
                        permission_name = permission.attrib['{http://schemas.android.com/apk/res/android}name']
                        fname_permission_map[filename].append(permission_name)
                os.chdir(os.pardir)
        with open('fname_permission_map.json', 'w') as outfile:
            json.dump(fname_permission_map, outfile, indent=4, sort_keys=True)
        os.chdir(os.pardir)

if __name__=='__main__':
    main()
