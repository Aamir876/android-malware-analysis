#!/usr/bin/python

# Before running this script, you can get samples by running something like
# ./samples_cli.py getbydate -at-key <API_KEY> 20160101:0000 20160401:0000
# and put the APKs in an 'all_apks' folder
# then this will submit their hashes to andrototal to see if they're malicious
# and sort them into folders based on that ('malicious_apk' and 'benign_apk')
# (make sure those folders exist before running this)
# (also replace <API_KEY> with your actual API KEY)

import subprocess
import os
import json
import glob
from configparser import ConfigParser

def main():
    config = ConfigParser()
    config.read('config.ini')
    API_KEY = config.get('AMA', 'API_KEY')
    for apk in glob.glob('all_apks/*.apk'):
        if not os.path.isfile(apk[:-4] + '_andrototal.json'):
            print('Checking ' + apk)
            analysis = subprocess.check_output('./tools/andrototal_cli.py analysis -at-key ' + API_KEY + ' ' + apk.split('/')[1][:-4], shell=True)
            with open(apk[:-4] + '_andrototal.json', 'w') as out_file:
                out_file.write(analysis)
        else:
            try:
                with open(apk[:-4] + '_andrototal.json') as json_file:
                    analysis = json.load(json_file)
            except ValueError:
                with open('invalid_andrototal_responses', 'a') as out_file:
                    out_file.write(apk.split('/')[1] + '\n')
                continue
            if all([test['result'] == 'NO_THREAT_FOUND' for test in analysis['tests']]):
                os.rename(apk, 'benign_apk/' + apk.split('/')[1])
            else:
                os.rename(apk, 'malicious_apk/' + apk.split('/')[1])

if __name__=='__main__':
    main()
