#!/bin/bash

# This script does several things to the folders containing apk files:
# 1. Each is unzipped into a folder
# 2. The AndroidManifest.xml files are converted from binary to ASCII
# 3. The classes.dex file is converted to classes-dex2jar.jar
# 4. The classes in the jar file are printed to classes.list
# 5. The jar file is disassembled to disassembled.code
# Dependencies: unzip, java, xmllint, dex2jar

original_dir=$(pwd)
for dir in malicious_apk benign_apk; do
  echo "Entering $dir"
  cd $dir
  rm -f valid_apks.txt
  rm -f malformed_xml.txt
  rm -f malformed_dex.txt
  for apk in *.apk; do
    folder="${apk::-4}"
    mkdir -p "$folder"
    rm -rf "$folder"/*
    echo "Extracting $apk"
    unzip -d "$folder" "$apk" 1>/dev/null
    if [ $(ls -l "$folder" | wc -l) -gt 1 ]; then
      echo "$apk" >> valid_apks.txt
      cd "$folder"
      if [ -e "AndroidManifest.xml" ]; then
        echo "Converting $folder/AndroidManifest.xml to ASCII"
        cp AndroidManifest.xml AndroidManifest_bin.xml
        java -jar ~/AXMLPrinter2.jar AndroidManifest_bin.xml > AndroidManifest_ascii.xml
        echo "Cleaning up $folder/AndroidManifest.xml"
        xmllint AndroidManifest_ascii.xml > AndroidManifest.xml
        if [ $? -ne 0 ]; then
          echo "$apk" >> ../malformed_xml.txt
        fi
      fi
      if [ -e "classes.dex" ]; then
        echo "Converting $folder/classes.dex to jar format"
        d2j-dex2jar.sh classes.dex
        if [ $? -ne 0 ]; then
          echo "$apk" >> ../malformed_dex.txt
        else
          jar -tf classes-dex2jar.jar > classes.list
          javap -c -classpath classes-dex2jar.jar $(jar -tf classes-dex2jar.jar | grep "class$" | sed s/\.class$//) > disassembled.code
        fi
      fi
      cd ..
    fi
  done
  cd $original_dir
done
