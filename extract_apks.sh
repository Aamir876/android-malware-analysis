#!/bin/bash

# This script extracts apks and cleans up the AndroidManifest.xml files.
# Dependencies: unzip, java, xmllint

original_dir=$(pwd)
for dir in malicious_apk benign_apk; do
  echo "Entering $dir"
  cd $dir
  rm -f valid_apks.txt
  rm -f malformed_xml.txt
  for apk in *.apk; do
    folder="${apk::-4}"
    mkdir -p "$folder"
    rm -rf "$folder"/*
    echo "Extracting $apk"
    unzip -d "$folder" "$apk" 1>/dev/null
    if [ $(ls -l "$folder" | wc -l) -gt 1 ]; then
      echo "$apk" >> valid_apks.txt
      cd "$folder"
      if [ -e "AndroidManifest.xml" ]; then
        echo "Converting $folder/AndroidManifest.xml to ASCII"
        cp AndroidManifest.xml AndroidManifest_bin.xml
        java -jar ~/AXMLPrinter2.jar AndroidManifest_bin.xml > AndroidManifest_ascii.xml
        echo "Cleaning up $folder/AndroidManifest.xml"
        xmllint AndroidManifest_ascii.xml > AndroidManifest.xml
        if [ $? -ne 0 ]; then
          echo "$apk" >> ../malformed_xml.txt
        fi
      fi
      cd ..
    fi
  done
  cd $original_dir
done
